image: "alpine"

stages:
  - lint
  - audit
  - test
  - build
  - e2e
  - package

.retry:
  retry: 2

.when:
  extends: .retry
  only:
    refs:
      - main

.frontend:
  extends: .when
  before_script:
    - cd frontend

.frontend-pnpm:
  extends: .frontend
  image: "node:22-alpine"
  before_script:
    - cd frontend
    - npm install -g pnpm@10
  cache:
    key: pnpm-store-frontend
    paths:
      - /root/.local/share/pnpm/**/*

.backend:
  extends: .when
  before_script:
    - cd backend

.backend-npm:
  extends: .backend
  image: "node:22-alpine"
  cache:
    key: node-modules-backend
    paths:
      - /root/.npm/**/*

.chatpopup:
  extends: .when
  before_script:
    - cd plugins/chat-popup

.chatpopup-pnpm:
  extends: .chatpopup
  image: "node:22-alpine"
  before_script:
    - cd plugins/chat-popup
    - npm install -g pnpm@10
  cache:
    key: pnpm-store-chatpopup
    paths:
      - /root/.local/share/pnpm/**/*

.frontend-playwright:
  extends: .frontend
  image: "mcr.microsoft.com/playwright:v1.47.0-focal"
  before_script:
    - cd frontend
    - npm install -g pnpm@10
  cache:
    key: pnpm-store-frontend
    paths:
      - /root/.local/share/pnpm/**/*

.backend-e2e-base:
  extends: .backend-npm
  services:
    - name: "mongo:4.2.8"
      alias: mongo
  variables:
    MONGO_HOST: "mongo"
    MONGO_PORT: "27017"
    E2E_MONGO_URI: "mongodb://mongo:27017/delta5"

lint-docker-frontend:
  extends: .frontend
  stage: lint
  image: "hadolint/hadolint:latest-debian"
  script:
    - /bin/hadolint Dockerfile
  only:
    changes:
      - frontend/Dockerfile

lint-docker-backend:
  extends: .backend
  stage: lint
  image: "hadolint/hadolint:latest-debian"
  script:
    - /bin/hadolint Dockerfile
  only:
    changes:
      - backend/Dockerfile

lint-frontend:
  extends: .frontend-pnpm
  stage: lint
  script:
    - if grep "material-ui/[^/]*'$" src -Rl ; then echo 'Do not import material ui through root' ; false ; fi
    - pnpm install --frozen-lockfile
    - pnpm run genversion
    - pnpm run lint
  only:
    changes:
      - frontend/**/*

lint-backend:
  extends: .backend-npm
  stage: lint
  script:
    - npm ci
    - npm run lint
  only:
    changes:
      - backend/**/*

test-backend:
  extends: .backend-npm
  stage: test
  services:
    - name: "mongo:4.2.8"
      alias: mongo
  variables:
    MONGO_HOST: "mongo"
    MONGO_PORT: "27017"
  script:
    - npm ci
    - DEBUG="infinity:*" npm run test
  artifacts:
    reports:
      junit: ./backend/junit.xml
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  needs: []
  only:
    changes:
      - backend/**/*

build-frontend:
  extends: .frontend-pnpm
  stage: build
  script:
    - |
      if [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        VERSION="${CI_COMMIT_SHORT_SHA}"
      else
        VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}
      fi
    - 'sed "s/\"gitVersion\":[^,]*/\"gitVersion\": \"${VERSION}\"/" -i package.json'
    - pnpm install --frozen-lockfile
    - GENERATE_SOURCEMAP=false npm run build
    - ls dist/index.html
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 day
  needs: []

build-backend:
  extends: .backend-npm
  stage: build
  script:
    - |
      if [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        VERSION=0.0.0-${CI_COMMIT_SHORT_SHA}+$(date '+%Y%m%d%H%M')
      else
        VERSION=${CI_COMMIT_TAG:-0.0.0-${CI_COMMIT_SHORT_SHA}+$(date '+%Y%m%d%H%M')}
      fi
    - 'sed "s/\"version\":[^,]*/\"version\": \"${VERSION}\"/" -i package.json'
    - npm ci
    - npm run build
  artifacts:
    paths:
      - backend/build
    expire_in: 1 day
  needs: []

build-backend-v2:
  stage: build
  image: "golang:1.25-alpine"
  before_script:
    - cd backend-v2
  script:
    - apk add --no-cache git
    - go mod download
    - go mod tidy
    - go build -ldflags="-s -w" -o backend-v2 .
    - chmod +x backend-v2
  artifacts:
    paths:
      - backend-v2/backend-v2
    expire_in: 1 day
  needs: []
  only:
    changes:
      - backend-v2/**/*

build-chatpopup:
  extends: .chatpopup-pnpm
  stage: build
  script:
    - |
      if [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        VERSION="0.0.0-${CI_COMMIT_SHORT_SHA}+$(date '+%Y%m%d%H%M')"
      else
        VERSION=${CI_COMMIT_TAG:-0.0.0-${CI_COMMIT_SHORT_SHA}+$(date '+%Y%m%d%H%M')}
      fi
    - 'sed "s/\"version\":[^,]*/\"version\": \"${VERSION}\"/" -i package.json'
    - pnpm install --frozen-lockfile
    - GENERATE_SOURCEMAP=false pnpm run build
    - ls dist/index.html
  artifacts:
    paths:
      - plugins/chat-popup/dist
    expire_in: 1 day
  needs: []

e2e-backend:
  extends: .backend-e2e-base
  stage: e2e
  script:
    - npm ci
    - cd ../backend-v2
    - apk add --no-cache bash curl
    - bash seed-e2e-users.sh
    - JWT_SECRET='GrFYK5ftZDtCg7ZGwxZ1JpSxyyJ9bc8uJijvBD1DYiMoS64ZpnBSrFxsNuybN1iO' MONGO_URI='mongodb://mongo:27017/delta5' PORT=3002 API_ROOT='/api/v2' MOCK_EXTERNAL_SERVICES=true nohup ./backend-v2 > backend-e2e.log 2>&1 & echo $! > backend-e2e.pid
    - sleep 5
    - if ! kill -0 $(cat backend-e2e.pid); then echo "Backend failed to start"; cat backend-e2e.log; exit 1; fi
    - curl -f http://localhost:3002/api/v2/health || (cat backend-e2e.log; exit 1)
    - cd ../backend
    - E2E_SERVER_URL=http://localhost:3002 E2E_API_BASE_PATH=/api/v2 npm run test:e2e || (kill $(cat ../backend-v2/backend-e2e.pid); exit 1)
    - kill $(cat ../backend-v2/backend-e2e.pid)
  artifacts:
    reports:
      junit: ./backend/junit.xml
    paths:
      - backend-v2/backend-e2e.log
    when: always
  needs:
    - build-backend-v2
  only:
    changes:
      - backend/**/*
      - backend-v2/**/*

e2e-frontend:
  extends: .frontend-playwright
  stage: e2e
  services:
    - name: "mongo:4.2.8"
      alias: mongo
  variables:
    MONGO_HOST: "mongo"
    MONGO_PORT: "27017"
    E2E_MONGO_URI: "mongodb://mongo:27017/delta5"
  script:
    - apt-get update && apt-get install -y curl
    - cd ../backend-v2
    - bash seed-e2e-users.sh
    - JWT_SECRET='GrFYK5ftZDtCg7ZGwxZ1JpSxyyJ9bc8uJijvBD1DYiMoS64ZpnBSrFxsNuybN1iO' MONGO_URI='mongodb://mongo:27017/delta5' PORT=3002 API_ROOT='/api/v2' MOCK_EXTERNAL_SERVICES=true nohup ./backend-v2 > backend-e2e.log 2>&1 & echo $! > backend-e2e.pid
    - sleep 5
    - if ! kill -0 $(cat backend-e2e.pid); then echo "Backend failed to start"; cat backend-e2e.log; exit 1; fi
    - curl -f http://localhost:3002/api/v2/health || (cat backend-e2e.log; exit 1)
    - cd ../frontend
    - pnpm install --frozen-lockfile
    - pnpm run genversion
    - nohup pnpm dev > vite-e2e.log 2>&1 & echo $! > vite-e2e.pid
    - sleep 10
    - curl -f http://localhost:5173 || (cat vite-e2e.log; kill $(cat ../backend-v2/backend-e2e.pid); exit 1)
    - E2E_ADMIN_USER=admin E2E_ADMIN_PASS='P@ssw0rd!' CI=true pnpm run test:e2e:ci || TEST_EXIT=$?
    - kill $(cat vite-e2e.pid) || true
    - kill $(cat ../backend-v2/backend-e2e.pid) || true
    - exit ${TEST_EXIT:-0}
  artifacts:
    reports:
      junit: ./frontend/junit.xml
    paths:
      - frontend/playwright-report
      - frontend/test-results
      - frontend/vite-e2e.log
      - backend-v2/backend-e2e.log
    when: always
  needs:
    - build-backend-v2
  only:
    changes:
      - frontend/**/*
      - backend-v2/**/*

package-frontend:
  extends: .frontend
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}"
      > /kaniko/.docker/config.json
    - |
      if [[ -n "${CI_MERGE_REQUEST_IID}" ]] ; then
        TAG=${CI_MERGE_REQUEST_IID}
        NAME="frontend-merge"
      elif [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        TAG=${CI_COMMIT_SHORT_SHA}
        NAME="frontend-branch"
      else
        TAG=${CI_COMMIT_REF_NAME/main/latest}
        NAME="frontend"
      fi
    - /kaniko/executor
      --context "$CI_PROJECT_DIR/frontend"
      --dockerfile Dockerfile
      --destination "$CI_REGISTRY_IMAGE:$NAME-$TAG"

package-backend:
  extends: .backend
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}"
      > /kaniko/.docker/config.json
    - |
      if [[ -n "${CI_MERGE_REQUEST_IID}" ]] ; then
        TAG=${CI_MERGE_REQUEST_IID}
        NAME="backend-merge"
      elif [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        TAG=${CI_COMMIT_SHORT_SHA}
        NAME="backend-branch"
      else
        TAG=${CI_COMMIT_REF_NAME/main/latest}
        NAME="backend"
      fi
    - /kaniko/executor
      --context "$CI_PROJECT_DIR/backend"
      --dockerfile Dockerfile
      --destination "$CI_REGISTRY_IMAGE:$NAME-$TAG"

package-chatpopup:
  extends: .chatpopup
  stage: package
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}"
      > /kaniko/.docker/config.json
    - |
      if [[ -n "${CI_MERGE_REQUEST_IID}" ]] ; then
        TAG=${CI_MERGE_REQUEST_IID}
        NAME="chatpopup-merge"
      elif [[ "${CI_COMMIT_REF_NAME}" != "${CI_COMMIT_REF_NAME/deploy/}" ]] ; then
        TAG=${CI_COMMIT_SHORT_SHA}
        NAME="chatpopup-branch"
      else
        TAG=${CI_COMMIT_REF_NAME/main/latest}
        NAME="chatpopup"
      fi
    - /kaniko/executor
      --context "$CI_PROJECT_DIR/plugins/chat-popup"
      --dockerfile Dockerfile
      --destination "$CI_REGISTRY_IMAGE:$NAME-$TAG"
